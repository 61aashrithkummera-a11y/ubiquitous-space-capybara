<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KummeraAI</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: #eef3fb; color: #0f172a; -webkit-font-smoothing:antialiased; }

    .app {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      background: #ffffff;
      border-bottom: 1px solid #e6edf3;
    }
    .brand { font-weight: 700; font-size: 18px; color: #0b1220; letter-spacing: 0.2px; }
    .top-actions { display:flex; gap:10px; align-items:center; }

    #status { font-size: 13px; color: #6b7280; margin-right: 8px; }

    .main {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
    }

    .messages {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 14px;
      background: linear-gradient(180deg,#ffffff,#fbfdff);
      border-radius: 12px;
      border: 1px solid #e6edf3;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg { max-width: 78%; padding: 10px 12px; border-radius: 12px; font-size: 14px; line-height: 1.4; word-break: break-word; }
    .msg.user { align-self: flex-end; background: linear-gradient(180deg,#2563eb,#1d4ed8); color: #fff; border-bottom-right-radius: 6px; }
    .msg.ai { align-self: flex-start; background: #f1f5f9; color: #0b1220; border-bottom-left-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; }

    .input-wrap {
      border-top: 1px solid #e6edf3;
      background: #ffffff;
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-bar {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fbfdff;
      border: 1px solid #e6edf3;
      padding: 8px;
      border-radius: 12px;
    }

    textarea#prompt {
      flex: 1;
      resize: none;
      border: none;
      outline: none;
      background: transparent;
      font-size: 14px;
      color: #0b1220;
      min-height: 40px;
      max-height: 120px;
      padding: 6px;
    }

    button#send {
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      color: white;
      border: none;
      padding: 9px 14px;
      font-size: 14px;
      border-radius: 10px;
      cursor: pointer;
    }

    button#new-chat {
      background: transparent;
      border: 1px solid #e6edf3;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: #0b1220;
      font-size: 13px;
    }

    .small-btn {
      background: transparent;
      border: none;
      color: #6b7280;
      cursor: pointer;
      font-size: 13px;
    }

    @media (max-width:640px) {
      .msg { max-width: 92%; }
      .brand { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">KummeraAI</div>
      <div class="top-actions">
        <div id="status">Ready</div>
        <button id="new-chat">New chat</button>
      </div>
    </div>

    <div class="main">
      <div class="messages" id="messages" aria-live="polite"></div>
    </div>

    <div class="input-wrap">
      <div class="input-bar">
        <textarea id="prompt" placeholder="Write a message… (Enter to send, Shift+Enter for newline)"></textarea>
      </div>
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');
    const newChatBtn = document.getElementById('new-chat');
    const statusEl = document.getElementById('status');

    let currentAbort = null;

    function setStatusText(t) { statusEl.textContent = t; }

    function addMessage(role, text) {
      const el = document.createElement('div');
      el.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
      el.textContent = text;
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return el;
    }

    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    newChatBtn.addEventListener('click', () => {
      if (currentAbort) currentAbort.abort();
      messagesEl.innerHTML = '';
      setStatusText('Ready');
      promptEl.value = '';
      promptEl.focus();
    });

    sendBtn.addEventListener('click', () => {
      const text = promptEl.value.trim();
      if (!text) return;
      promptEl.value = '';
      addMessage('user', text);
      // Show immediate thinking status and a placeholder AI message
      setStatusText('Thinking…');
      const aiElem = addMessage('ai', '');
      // small delay to show "Thinking…" then start generating
      setTimeout(() => {
        setStatusText('Generating response…');
        startStream(text, aiElem);
      }, 300);
    });

    function startStream(prompt, aiElem) {
      if (currentAbort) currentAbort.abort();
      const controller = new AbortController();
      currentAbort = controller;

      fetch('/api/respond', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt }),
        signal: controller.signal
      }).then(res => {
        if (!res.ok) {
          return res.text().then(t => { aiElem.textContent = 'Error: ' + t; setStatusText('Error'); throw new Error(t); });
        }
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function read() {
          reader.read().then(({ done, value }) => {
            if (done) {
              setStatusText('Ready');
              currentAbort = null;
              return;
            }
            buffer += decoder.decode(value, { stream: true });
            const parts = buffer.split(/\n\n/);
            buffer = parts.pop();
            for (const part of parts) {
              if (!part.trim()) continue;
              const m = part.match(/^data: (.*)$/m);
              if (!m) continue;
              const data = m[1];
              if (data === '[DONE]') {
                setStatusText('Ready');
                controller.abort();
                currentAbort = null;
                return;
              }
              try {
                const obj = JSON.parse(data);
                if (obj.token !== undefined) {
                  aiElem.textContent += obj.token;
                  messagesEl.scrollTop = messagesEl.scrollHeight;
                }
              } catch (err) {
                console.error('parse error', err, data);
              }
            }
            read();
          }).catch(err => {
            if (err.name === 'AbortError') {
              setStatusText('Ready');
              currentAbort = null;
              return;
            }
            console.error('stream error', err);
            setStatusText('Error');
          });
        }
        read();
      }).catch(err => {
        if (err.name === 'AbortError') { setStatusText('Ready'); return; }
        console.error('fetch failed', err);
        setStatusText('Error');
        aiElem.textContent = 'hello';
      });
    }

    window.addEventListener('load', () => promptEl.focus());
  </script>
</body>
</html>
